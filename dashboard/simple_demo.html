<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Transportation - Driver Scores Demo</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .header {
            background: #2c3e50;
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
        }
        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #3498db;
        }
        .scores-table {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #34495e;
            color: white;
        }
        .score-good { color: #27ae60; font-weight: bold; }
        .score-warning { color: #f39c12; font-weight: bold; }
        .score-danger { color: #e74c3c; font-weight: bold; }
        .status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
        }
        .status-online { background: #d5f4e6; color: #27ae60; }
        .status-offline { background: #fadbd8; color: #e74c3c; }
        .refresh-info {
            text-align: center;
            color: #7f8c8d;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ðŸš— Smart Transportation System</h1>
            <p>Real-time Driver Scoring Dashboard</p>
        </div>

        <div class="stats">
            <div class="stat-card">
                <div class="stat-value" id="activeDevices">0</div>
                <div>Active Devices</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="avgScore">0.0</div>
                <div>Average Score</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalScores">0</div>
                <div>Total Scores</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="apiStatus">ðŸ”´</div>
                <div>API Status</div>
            </div>
        </div>

        <div class="scores-table">
            <table>
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>Device ID</th>
                        <th>Driver Score</th>
                        <th>Model</th>
                        <th>Speed</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="scoresTableBody">
                    <tr>
                        <td colspan="6" style="text-align: center; color: #7f8c8d;">
                            Loading driver scores...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="refresh-info">
            Auto-refreshing every 1 second | Last update: <span id="lastUpdate">Never</span>
        </div>
    </div>

    <script>
        let demoData = [];
        let deviceStats = {};

        // Generate demo data if API is not available
        function generateDemoData() {
            const devices = ['OBU-DEMO-01', 'OBU-DEMO-02', 'OBU-DEMO-03'];
            const models = ['random_forest', 'heuristic'];
            
            return devices.map(deviceId => ({
                timestamp: Math.floor(Date.now() / 1000),
                device_id: deviceId,
                driver_score: Math.random() * 100,
                model: models[Math.floor(Math.random() * models.length)],
                speed: 30 + Math.random() * 90,
                status: Math.random() > 0.1 ? 'online' : 'offline'
            }));
        }

        function getScoreClass(score) {
            if (score >= 80) return 'score-danger';
            if (score >= 50) return 'score-warning';
            return 'score-good';
        }

        function formatTime(timestamp) {
            return new Date(timestamp * 1000).toLocaleTimeString();
        }

        function updateStats(scores) {
            const activeDevices = new Set(scores.map(s => s.device_id)).size;
            const avgScore = scores.length > 0 ? 
                scores.reduce((sum, s) => sum + s.driver_score, 0) / scores.length : 0;
            
            document.getElementById('activeDevices').textContent = activeDevices;
            document.getElementById('avgScore').textContent = avgScore.toFixed(1);
            document.getElementById('totalScores').textContent = scores.length;
        }

        function updateTable(scores) {
            const tbody = document.getElementById('scoresTableBody');
            
            if (scores.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; color: #7f8c8d;">
                            No driver scores available
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = scores.slice(0, 20).map(score => `
                <tr>
                    <td>${formatTime(score.timestamp)}</td>
                    <td>${score.device_id}</td>
                    <td class="${getScoreClass(score.driver_score)}">
                        ${score.driver_score.toFixed(1)}
                    </td>
                    <td>${score.model}</td>
                    <td>${score.speed ? score.speed.toFixed(1) + ' km/h' : 'N/A'}</td>
                    <td>
                        <span class="status status-${score.status || 'online'}">
                            ${(score.status || 'online').toUpperCase()}
                        </span>
                    </td>
                </tr>
            `).join('');
        }

        async function fetchScores() {
            try {
                const response = await fetch('http://localhost:5000/health');
                if (response.ok) {
                    document.getElementById('apiStatus').textContent = 'ðŸŸ¢';
                    // API is available, but we'll use demo data for this prototype
                    const newScores = generateDemoData();
                    demoData = [...newScores, ...demoData].slice(0, 50);
                } else {
                    throw new Error('API not available');
                }
            } catch (error) {
                document.getElementById('apiStatus').textContent = 'ðŸ”´';
                // Use demo data
                const newScores = generateDemoData();
                demoData = [...newScores, ...demoData].slice(0, 50);
            }

            updateStats(demoData);
            updateTable(demoData);
            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
        }

        // Initial load
        fetchScores();

        // Auto-refresh every second
        setInterval(fetchScores, 1000);

        // Add some initial demo data
        demoData = Array.from({length: 10}, (_, i) => ({
            timestamp: Math.floor(Date.now() / 1000) - i * 5,
            device_id: `OBU-DEMO-${String(i % 3 + 1).padStart(2, '0')}`,
            driver_score: Math.random() * 100,
            model: Math.random() > 0.5 ? 'random_forest' : 'heuristic',
            speed: 30 + Math.random() * 90,
            status: 'online'
        }));
    </script>
</body>
</html>